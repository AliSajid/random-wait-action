name: Scorecard supply-chain security
on:
    branch_protection_rule:
    schedule:
        - cron: '30 1 * * 4'
    push:
        branches: ['next']

permissions: read-all

jobs:
    analysis:
        name: Scorecard analysis
        runs-on: ubuntu-latest
        permissions:
            security-events: write
            id-token: write

        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  disable-sudo: true
                  egress-policy: audit
                  allowed-endpoints: >
                      github.com:443
                      mise.jdx.dev:443
                      registry.npmjs.org:443
                      raw.githubusercontent.com:443
                      mise-versions.jdx.dev:443
                      index.crates.io:443
                      static.crates.io:443
                      nodejs.org:443

            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  persist-credentials: false

            - name: Run analysis
              uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
              with:
                  results_file: results.sarif
                  results_format: sarif
                  publish_results: true

            - name: Upload artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.pre.node20
              with:
                  name: SARIF file
                  path: results.sarif
                  retention-days: 5

            - name: Upload to code-scanning
              uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4
              with:
                  sarif_file: results.sarif
