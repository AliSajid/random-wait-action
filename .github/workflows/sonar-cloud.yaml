name: Run SonarCloud scan
on:
    push:
        branches:
            - main
            - next
    pull_request:
        types:
            - opened
            - synchronize
            - reopened

permissions:
    contents: read

jobs:
    sonarcloud:
        permissions:
            contents: read # for actions/checkout to fetch code
        name: SonarCloud
        runs-on: ubuntu-latest
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
              with:
                  disable-sudo: true
                  egress-policy: audit
                  allowed-endpoints: >
                      api.github.com:443
                      api.sonarcloud.io:443
                      binaries.sonarsource.com:443
                      github.com:443
                      index.crates.io:443
                      mise-versions.jdx.dev:443
                      mise.jdx.dev:443
                      nodejs.org:443
                      registry.npmjs.org:443
                      release-assets.githubusercontent.com:443
                      scanner.sonarcloud.io:443
                      sonarcloud.io:443
                      static.crates.io:443

            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  fetch-depth: 0

            - name: Install mise
              uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
              with:
                  version: 2026.2.19
                  install_args: --yes

            - name: Generate Coverage Report
              run: mise run test

            - name: SonarCloud Scan
              uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Needed to get PR information, if any
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
